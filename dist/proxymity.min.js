"use strict";var proxymity=function(e){function n(e){return Array.prototype.slice.call(e||[])}function t(e,t){return n(e).forEach(t)}function r(e){return"function"==typeof e}function o(e){return"string"==typeof e}function i(e){return"boolean"==typeof e}function a(e){return"number"==typeof e&&!isNaN(e)}function u(e){return"object"==typeof e}function c(e){return Object.getOwnPropertyNames(e)}function f(e,n){var t,r,o;return void 0===n||e>n?(r=e,t=n||0):(t=e,r=n),o=r-t,Math.round(Math.random()*(o+.9998)-.4999)+t}var s="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_";function l(e=16){for(var n=s[f(51)],t=1;t<e;t++)n+=s[f(62)];return n}function v(e,n){var r=c(n);for(var o in e)n[o]=e[o],r.splice(r.indexOf(o),1);t(r,function(e,t){e||"length"===t||delete n[t]}.bind(null,Array.isArray(n)))}function p(e,n,t){return Object.defineProperty(e,n,{value:t}),t}var h,d=function(){var e={},n={},o={},i=(o.watch=function(t,o,i){var a,u;for(var c in r(o)?(a=t,u=o,i=i||{}):(a="**",u=t,i=o||{}),i)u.key=i.key;if(a.indexOf("*")>-1)var f=a.replace(/([!@#$%^&*(){}[\]\<\>:'"`\-_,./\\+-])/g,"\\$1").replace(/\\\*\\\*/g,".*").replace(/\\\*/,"[^:.]+"),s=(n[a]=n[a]||{regex:new RegExp(f),listeners:[]}).listeners;else s=e[a]=e[a]||[];return s.push(u),function(){s.splice(s.indexOf(u),1)}},{}),a=o.emit=function(r,o={}){for(var a=e[r]&&e[r].slice(),u=0;a&&u<a.length;u++)e[r].indexOf(a[u])>-1&&a[u](o,r);for(var c in n){var f=n[c];r.match(f.regex)&&t(f.listeners,function(e){e(o,r)})}return i[r]=o},u={},s=0,v=0,p=l(f(32,48)),h=!1;o.async=function(e,n={}){h||(window.postMessage(p,"*"),h=!0),u[e]=n,n.f=s+=1};window.addEventListener("message",function(e){if(e.data===p){e.stopPropagation();var n=u;if(h=!1,u={},s=0,++v>3)return v=0,void a("renderend");var r=c(n);r.sort(function(e,t){return n[e].f>n[t].f?1:n[e].f<n[t].f?-1:0}),a("asyncstart",{payload:n,order:r}),t(r,function(e){a(e,n[e])}),a("asyncend",n),h||(v=0,a("renderend"))}});o.last=function(e){return i[e]},o.next=function(e){return u[e]};return o}(),y={[Symbol.toPrimitive]:function(e){return"number"==e?c(this).length:"string"==e?y.toString.call(this):!!c(this).length}},g=Object.create(Array.prototype);p(g,h="objectify",p(y,h,function(){if(Array.isArray(this))var e=[];else e={};var n=c(this);for(var t in n){var r=n[t];u(this[r])&&this[r].objectify?e[r]=this[r].objectify():e[r]=this[r]}return e})),p(g,h="stringify",p(y,h,function(){var e=n(arguments);return e.unshift(y.objectify.call(this)),JSON.stringify.apply(JSON,e)})),p(g,h="toString",p(y,h,function(){return c(this).length?y.stringify.call(this):""})),p(g,h="watch",p(y,h,function(n,t){var r=this;return O(function(){return e.call(r,"this"+("["===n[0]?"":".")+n)},function(e){e&&t(e.value)})}));var m=l(f(32,48)),b=l(f(32,48)),w=l(f(32,48));function k(e){var n,o=Object.getPrototypeOf(e);if(u(e)&&(o===Object.prototype&&(n=Object.create(y))||o===Array.prototype&&(n=Object.setPrototypeOf([],g)))){var i,a={[m]:function(e){return a[e]},[b]:s(b,"remap:"),[w]:s(w,"del:")};function s(e,n){return function(){t(c(p),function(t){var o=p[t][e];r(o)&&o();var i={p:t};!d.next(n+a[t])&&d.async(n+a[t],i),Array.isArray(p)&&"length"===t&&(i.f=-1)})}}var p=new Proxy(n,i={get:function(e,n){if(n in e||n in a){if(!(n in e)&&n in a)return a[n]}else i.set(e,n,{});return a.hasOwnProperty(n)||(a[n]=l(f(32,48))),d.emit("get",{value:a[n]}),void 0===e[n]||null===e[n]?"":e[n]},set:function(e,n,t){try{var o=Object.getPrototypeOf(t)}catch(e){}var i=Array.isArray(e);if(i){var c=e.length;a.hasOwnProperty("length")||(a.length=l(f(32,48)))}var s=e[n]&&e[n][b];r(s)&&s(),t&&u(t)&&(o===Object.prototype||o===Array.prototype)?e[n]=k(t):e[n]=t,a.hasOwnProperty(n)||(a[n]=l(f(32,48)));var v={value:e[n],p:n};if(d.async("set:"+a[n],v),i&&"length"===n&&(v.f=-2),i&&c!==e.length){var p={value:e.length,p:n};d.async("set:"+a.length,p),p.f=-2}return Array.isArray(e[n])&&(e[n].length=e[n].length),!0},deleteProperty:function(e,n){if(n in e){var t=e[n][b];return r(t)&&t(),d.async("del:"+a[n],{value:e[n],p:n}),delete a[n],delete e[n],!0}return!1}});return v(e,p),p}}function O(e,n,o=[]){e();var i=d.last("get").value;if(r(n)){n=[{to:"del",fn:n},{to:"set",fn:n}]}t(n,function(e){var n=e.to+":"+i;o.push(d.watch(n,e.fn)),e.fn(d.last(n))});var a=function(){t(o,function(e){e()}),o.length=0},u=function(){a(),O(e,n,o)};return o.push(d.watch("remap:"+i,u)),o.push(d.watch("del:"+i,u)),a}function A(n,r,o){var i=n.textContent,a=[];if(i.replace(/\{\:([\s\S]*?)\:\}(\|(\s|\n)*\{[\s\S]*?\}(\s|\n)*\|)?/g,function(e,n,t){a.push({drop:e,run:n,on:t&&t.replace(/^\|[\s\n]*\{|\}[\s\n]*\|$/g,"").split(/\}[\s\n]*\,[\s\n]*\{/g)})}),a.length){var u=[],c=function(){var o,u;n.textContent=(o=i,u=r,t(a,function(n){o=o.replace(n.drop,function(){return e.call(u,n.run)})}),o)};return t(a,function(n){l(f(32,48));if(n.on){t(n.on,function(n){c.bind(null),c.bind(null);u.push(O(function(){e.call(r,"this."+o+("["===n[0]?"":".")+n)},c))})}else u.push(d.watch("asyncstart",c)),c()}),function(){t(u,function(e){e()})}}}var x=Object.create(Array.prototype);p(x,"appendTo",function(e){if(o(e))return x.appendTo.call(this,document.querySelector(e));var n=e;return t(this,function(e){n.appendChild(e)}),this}),p(x,"detach",function(){return t(this,function(e){var n=e.parentElement;n&&n.removeChild(e)}),this}),p(x,"unlink",function(){return j(this),this});var E=["renderend"];function N(e,n){t(e,function(e,t,r){n(e),N(e.childNodes,n)})}function j(e){N(e,function(e){e.dispatchEvent(new CustomEvent(C))})}p(x,"when",function(e){if(-1===E.indexOf(e))throw new Error("Cannot subscribe to "+e);return new Promise(function(n){var t=d.watch(e,function(){t(),n()})})});var C=l(f(32,48));function P(n,o,i,a){return O(function(){var n=function(){return n};return n.in=function(e){if(!e||!r(e[m]))throw new Error("Improper usage of key(string).in(array): in(array) is not provided with a proxified object of the same root");i.c=e},n.end=function(){},e.call(i.n,i.n.textContent,{key:n}),i.c.length},function(){var e,r,u,c=i.t,f=c.indexOf(i.u),s=c.indexOf(i.n),l=i.u.parentNode,v=(e=c.slice(s+1,f),r=i.key,u=[],t(e,function(e){var n=e[r];u[n]=u[n]||[],u[n].push(e)}),u),p=+i.c.length;if(v.length<p)for(;v.length!==p;){var h=i.i.map(function(e){return e.cloneNode(!0)}),d=function(e,n){a(n),N(n,function(n){Object.defineProperty(n,i.key,{configurable:!0,enumerable:!1,get:function(){return e}})})}.bind(this,v.length);d(h),S(h,n,o,d),l&&t(h,function(e){l.insertBefore(e,i.u)}),i.m&&t(h,function(e){e instanceof HTMLElement&&i.m(e)}),c.splice.apply(c,[f,0].concat(h)),f+=h.length,v.push(h)}else if(v.length>p)for(;v.length!==p;){var y=v.pop();t(y,function(e){c.splice(c.indexOf(e),1),e.parentNode&&e.parentNode.removeChild(e)}),j(y)}})}function L(e){return function(n){n.stopPropagation(),t(e,function(e){e()})}}function S(c,s,p,h=function(){}){if(o(c)){var d=document.createElement("template");return d.innerHTML=c.trim(),S(d.content.childNodes,s,p,h)}if(c instanceof NodeList||c instanceof Array&&c.reduce(function(e,n){return e&&n instanceof Node},!0)){var y,g=n(c),m=function(e){if(y)throw new error("Improper usage of key(string).in(array): key(string) cannot be nested on the same level");return y={key:e},m};return m.in=function(e){if(!y)throw new Error("Improper usage of key(string).in(array): key(string) not called");if(y.c)throw new Error("Improper usage of key(string).in(array): in(array) called before key");y.i=[]},m.end=function(e){if(!(y&&y.key&&y.i&&y.i.length))throw new Error("Improper usage of key.end([onClone]): key(string).in(array) is not called properly prior to calling key.end([onClone])");y.t=g,y.u=y.i.pop(),r(e)&&(y.m=e);for(var n=y.i,t=g.length-1;t>=0;t--)if(-1!==n.indexOf(g[t])){var o=g[t].parentNode;o&&o.removeChild(g[t]),g.splice(t,1)}var i=y.n=y.u.previousSibling,a=L([P(s,p,y,h),function(){i.removeEventListener(C,a)}]);i.addEventListener(C,a),y=void 0},t(g,function(n){if(y&&y.i&&y.i.push(n),n instanceof Comment&&"foreach:"===n.textContent.trim().substr(0,8).toLowerCase()){if(S(n,s,p,h),e.call(n,n.textContent,{key:m}),!(!y||y.key&&y.i))throw new Error("Improper usage of key(string).in(array): in(array) not called in conjunction with key");y&&!y.n&&(y.n=n)}}),t(g,function(e){e[p]!==s&&S(e,s,p,h)}),Object.setPrototypeOf(g,x)}if(c instanceof Node){var b=c,w=[];if(Object.defineProperty(b,p,{configurable:!0,get:function(){return s},set:function(e){u(e)&&v(e,s)}}),w.push(function(){delete b[p]}),b instanceof CharacterData){var k=A(b,b,p);k&&w.push(k)}else S(b.childNodes,s,p,h);t(b.attributes,function(n){var r=A(n,b,p);if(r&&w.push(r),!("name"!==n.name||"INPUT"!==b.nodeName&"TEXTAREA"!==b.nodeName&"SELECT"!==b.nodeName)){var o=function(e){try{var n=e.value.toString();n!==b.value&&(b.value=n)}catch(e){b.value=null}},u="value",c=b.type.toLowerCase();"number"===c||"range"===c?(u="valueAsNumber",o=function(e){e&&a(e.value)?a(e.value)&&e.value!==b.valueAsNumber&&(b.valueAsNumber=e.value):b.value=null}):"checkbox"===c?(u="checked",o=function(e){!e||i(e.value)?b.checked=!1:i(e.value)&&e.value!==b.checked&&(b.checked=e.value)}):"radio"===c?o=function(e){try{var n=e.value.toString();e&&b.value===n&&!0!==b.checked?b.checked=!0:e&&b.value!==n&&!0===b.checked&&(b.checked=!1)}catch(e){b.checked=!1}}:"date"!==c&&"month"!==c&&"week"!==c&&"time"!==c&&"datetime-local"!==c||(u="valueAsDate",o=function(e){e&&e.value instanceof Date?e.value instanceof Date&&e.value.getTime()!==b.valueAsDate.getTime()&&(b.valueAsDate=e.value):b.value=null}),w.push(O(function(){e.call(b,"this."+p+("["===n.value[0]?"":".")+n.value)},[{to:"del",fn:o},{to:"set",fn:o}]));var s=["change","keyup","click"],v=function(t){var r=l(f(32,48));e.call(b,"this."+p+("["===n.value[0]?"":".")+n.value+" = "+r,{[r]:b[u]})};t(s,function(e){b.addEventListener(e,v)}),w.push(function(){t(s,function(e){b.removeEventListener(e,v)})})}}),w.push(function(){b.removeEventListener(C,E)});var E=L(w);return b.addEventListener(C,E),Object.setPrototypeOf([b],x)}}var T=function(e,n={},t="app"){var o,i=n[m];o=r(i)?n:k(n),d.async("set:");var a=S(e,o,t);return Object.defineProperty(a,t,{get:function(){return o},set:function(e){u(e)&&v(e,o)}}),a};return p(T,"convert",k),T}(function(s,sv={}){var os=s;for(let e in sv)s="var "+e+" = sv."+e+";\n"+s;try{return eval(s)}catch(e){return console.error("failed to evaluate expression ["+os+"]",this,e),""}});"undefined"!=typeof module&&(module.exports=proxymity);